<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - collada - skinning</title>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
		/>
		<link type="text/css" rel="stylesheet" href="main.css" />
	</head>
	<body>
		<div id="container"></div>
		<div id="info">
			<a href="https://threejs.org" target="_blank" rel="noopener">three.js</a>
			collada loader - skinning<br />
			Dancing Stormtrooper by
			<a
				href="https://sketchfab.com/strykerdoesgames"
				target="_blank"
				rel="noopener"
				>StrykerDoesAnimation</a
			>,
			<a
				href="https://creativecommons.org/licenses/by/4.0/"
				target="_blank"
				rel="noopener"
				>CC Attribution</a
			>
		</div>

		<script type="importmap">
			{
				"imports": {
					"three": "../build/three.module.js",
					"three/addons/": "./jsm/"
				}
			}
		</script>

		<script src="../gsap/gsap.min.js"></script>
		<script type="module">
			import * as THREE from "three";

			import Stats from "three/addons/libs/stats.module.js";

			import { ColladaLoader } from "three/addons/loaders/ColladaLoader.js";
			import { OrbitControls } from "three/addons/controls/OrbitControls.js";
			import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
			import { KTX2Loader } from "three/addons/loaders/KTX2Loader.js";

			// ----- Scene cơ bản -----
			const scene = new THREE.Scene();
			scene.background = new THREE.Color(0xe0e0e0);

			const camera = new THREE.PerspectiveCamera(
			60,
				window.innerWidth / window.innerHeight,
				0.1,
				1000
			);
			camera.position.set(30, 30, 30);
			// camera.lookAt(0, 0, 0);

			const renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			const controls = new OrbitControls(camera, renderer.domElement);
			controls.enableDamping = true;
			controls.screenSpacePanning = true;
			controls.minDistance = 10;
			controls.maxDistance = 100;
			// controls.target.set( 0, 2, 0 );
			controls.update();

			// ----- Ánh sáng -----
			scene.add(new THREE.AmbientLight(0x404040, 2));
			const dirLight = new THREE.DirectionalLight(0xffffff, 2);
			dirLight.position.set(10, 20, 10);
			scene.add(dirLight);

			// Tạo AxesHelper với chiều dài của các trục là 5
			const axesHelper = new THREE.AxesHelper(5);
			scene.add(axesHelper);

			// ----- Sàn -----
			const floor = new THREE.Mesh(
				new THREE.PlaneGeometry(100, 100),
				new THREE.MeshPhongMaterial({ color: 0xcccccc })
			);
			floor.rotation.x = -Math.PI / 2;
			scene.add(floor);

			// ----- Băng chuyền -----
			const conveyor = new THREE.Mesh(
				new THREE.BoxGeometry(10, 0.5, 2),
				new THREE.MeshPhongMaterial({ color: 0x333333 })
			);
			conveyor.position.set(0, 0.25, 0);
			scene.add(conveyor);

			// ----- Hộp trên băng chuyền -----
			const box = new THREE.Mesh(
				new THREE.BoxGeometry(1, 1, 1),
				new THREE.MeshPhongMaterial({ color: 0xff0000 })
			);
			box.position.set(-4.5, 1, 0);
			scene.add(box);

			// ----- Load GLB model -----
			const loader = new GLTFLoader();
			// loader.load("models/rusty_electric_box.glb", function (gltf) {
			// 	const agv = gltf.scene;
			// 	agv.scale.set(0.5, 0.5, 0.5);
			// 	agv.position.set(-4.5, 0.5, 0);
			// 	agv.rotation.y = -Math.PI / 0.79;
			// 	scene.add(agv);

			// 	function moveAGV() {
			// 		requestAnimationFrame(moveAGV);
			// 		agv.position.x += 0.05;
			// 		if (agv.position.x > 5) agv.position.x = -5;
			// 	}
			// 	moveAGV();
			// });

			// ----- Máy móc (giả lập) -----
			const machine = new THREE.Mesh(
				new THREE.BoxGeometry(3, 3, 3),
				new THREE.MeshPhongMaterial({ color: 0x0077ff })
			);
			machine.position.set(6.5, 1.5, 0);
			scene.add(machine);

			// ----- AGV (xe nhỏ) -----
			const agv = new THREE.Mesh(
				new THREE.BoxGeometry(2, 1, 2),
				new THREE.MeshPhongMaterial({ color: 0x00cc66 })
			);
			agv.position.set(0, 0.5, -20);
			scene.add(agv);

			// Waypoints hình chữ nhật
			const waypoints = [
				{ x: 20, z: -20, duration: 5 },
				{ x: 20, z: 20, duration: 2 },
				{ x: -20, z: 20, duration: 5 },
				{ x: -20, z: -20, duration: 8 },
				{ x: -0, z: -20, duration: 5 },
			];

			// Tạo đường đi (line) từ waypoints
			const points = waypoints.map((p) => new THREE.Vector3(p.x, 0.01, p.z));
			// thêm điểm bắt đầu (vị trí agv hiện tại) vào đầu mảng
			points.unshift(new THREE.Vector3(agv.position.x, 0.01, agv.position.z));

			const geometry = new THREE.BufferGeometry().setFromPoints(points);
			const material = new THREE.LineBasicMaterial({
				color: 0xff0000,
				linewidth: 2,
			});
			const line = new THREE.Line(geometry, material);
			scene.add(line);

			function moveAGV(obj, waypoints) {
				let tl = gsap.timeline({ repeat: -1 });
				waypoints.forEach((p) => {
					tl.to(obj.position, {
						duration: p.duration,
						x: p.x,
						z: p.z,
						onUpdate: () => {
							let dir = new THREE.Vector3(
								p.x - obj.position.x,
								0,
								p.z - obj.position.z
							);
							obj.rotation.y = Math.atan2(dir.x, dir.z);
						},
					});
				});
			}
			moveAGV(agv, waypoints);

			// // Các waypoint
			// const waypoints = [
			// 	new THREE.Vector3(20, 0, -20),
			// 	new THREE.Vector3(20, 0, 20),
			// 	new THREE.Vector3(-20, 0, 20),
			// 	new THREE.Vector3(-20, 0, -20),
			// 	new THREE.Vector3(0, 0, -20),
			// ];

			// const radius = 3; // độ bo góc
			// let pathPoints = [];

			// for (let i = 0; i < waypoints.length; i++) {
			// 	const prev = waypoints[(i - 1 + waypoints.length) % waypoints.length];
			// 	const curr = waypoints[i];
			// 	const next = waypoints[(i + 1) % waypoints.length];

			// 	// Vector hướng
			// 	const v1 = new THREE.Vector3().subVectors(curr, prev).normalize();
			// 	const v2 = new THREE.Vector3().subVectors(curr, next).normalize();

			// 	// Điểm trước và sau góc
			// 	const p1 = curr.clone().sub(v1.multiplyScalar(radius));
			// 	const p2 = curr.clone().sub(v2.multiplyScalar(radius));

			// 	if (i === 0) pathPoints.push(p1);

			// 	// Tạo curve bo tròn tại góc
			// 	const curve = new THREE.QuadraticBezierCurve3(p1, curr, p2);
			// 	pathPoints.push(...curve.getPoints(10));
			// }

			// // Tạo curve tổng từ các điểm
			// const smoothCurve = new THREE.CatmullRomCurve3(pathPoints, true); // true = loop

			// // Vẽ line cho dễ quan sát
			// const geometry = new THREE.BufferGeometry().setFromPoints(
			// 	smoothCurve.getPoints(200)
			// );
			// const material = new THREE.LineBasicMaterial({ color: 0xff0000 });
			// const line = new THREE.Line(geometry, material);
			// scene.add(line);

			// let progress = 0; // 0 -> 1
			// const speed = 0.05; // tốc độ
			// const clock = new THREE.Clock();

			// function animateAGV(agv) {
			// 	progress += speed * clock.getDelta();
			// 	if (progress > 1) progress = 0;

			// 	// Lấy vị trí từ đường
			// 	const pos = smoothCurve.getPointAt(progress);
			// 	agv.position.copy(pos);

			// 	// Lấy hướng (tangent vector)
			// 	const tangent = smoothCurve.getTangentAt(progress).normalize();
			// 	agv.rotation.y = Math.atan2(tangent.x, tangent.z);
			// }

			// ----- Animation -----
			let angle = 0;
			function animate() {
				requestAnimationFrame(animate);
				// animateAGV(agv);

				// Hộp chạy trên băng chuyền
				box.position.x += 0.05;
				if (box.position.x > 5) box.position.x = -5;

				// // AGV chạy vòng quanh
				// angle += 0.01;
				// agv.position.x = Math.cos(angle) * 15;
				// agv.position.z = Math.sin(angle) * 15;

				controls.update();
				renderer.render(scene, camera);
			}
			animate();

			// Resize window
			window.addEventListener("resize", () => {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
			});
		</script>
	</body>
</html>
